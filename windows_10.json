{
  "builders": [
    {
      "type": "hyperv-iso",

      "iso_url": "{{user `iso_url`}}",
      "iso_checksum": "{{user `iso_checksum`}}",
      "iso_checksum_type": "{{user `iso_checksum_type`}}",

      "cpus": 2,
      "memory": 4096,
      "disk_size": "{{user `disk_size`}}",
      "communicator": "winrm",

      "winrm_username": "vagrant",
      "winrm_password": "vagrant",
      "winrm_timeout": "{{user `winrm_timeout`}}",

      "floppy_files": [
        "{{user `autounattend`}}",
        "./scripts/disable-winrm.ps1",
        "./scripts/enable-winrm.ps1",
        "./scripts/fixnetwork.ps1"
      ],
      "shutdown_command": "shutdown /s /t 10 /f /d p:4:1 /c \"Packer Shutdown\""
    }
  ],
  "provisioners": [
    {
      "type": "powershell",
      "inline": [
        "& $env:SystemRoot\\System32\\Sysprep\\Sysprep.exe /oobe /generalize /quiet /quit",
        "while($true) { $imageState = Get-ItemProperty HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Setup\\State | Select ImageState; if($imageState.ImageState -ne 'IMAGE_STATE_GENERALIZE_RESEAL_TO_OOBE') { Write-Output $imageState.ImageState; Start-Sleep -s 10  } else { break } }"
      ]
    }
  ],
  "variables": {
    "autounattend": "./answer_files/10/Autounattend.xml",

    "disk_size": "61440",

    "iso_url": "",
    "iso_checksum": "",
    "iso_checksum_type": "",

    "winrm_timeout": "6h"
  }
}